name: Repository Generator (write)

on:
  push:
    branches:
      - main
    paths-ignore:
      # Avoid infinite loops from the auto-generated release commit.
      - BlueRepository.blue

concurrency:
  group: repository-generator-main
  cancel-in-progress: false

permissions:
  contents: write

env:
  REPOSITORY_GENERATOR_PACKAGE: '@blue-labs/repository-generator'
  REPOSITORY_GENERATOR_VERSION: '2.0.0-rc.20'
  BLUE_REPOSITORY_PATH: 'BlueRepository.blue'
  ARTIFACT_NAME: 'blue-repository-definition'
  ARTIFACT_RETENTION_DAYS: '10'
  DOWNSTREAM_REPO: 'bluecontract/blue-repository-js'
  DOWNSTREAM_EVENT_TYPE: 'blue-preprocessor-completed'
  SOURCE_WORKFLOW_FILE: 'blue-preprocessor.yml'

jobs:
  Generate:
    name: Generate BlueRepository.blue
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_PAT || github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure Git
        shell: bash
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Run repository-generator (write)
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main
          git checkout -B main origin/main

          npm_config_loglevel=error \
            npm exec --yes --package "${REPOSITORY_GENERATOR_PACKAGE}@${REPOSITORY_GENERATOR_VERSION}" -- \
            blue-repo-generator --repo-root . --blue-repository "${BLUE_REPOSITORY_PATH}" --mode write \
            | tee /tmp/repository-generator-output.txt

          repoBlueId="$(tail -n 1 /tmp/repository-generator-output.txt | tr -d '\r')"
          if [ -z "${repoBlueId}" ]; then
            echo "Failed to read RepoBlueId from generator output."
            exit 1
          fi

          echo "repo_blue_id=${repoBlueId}" >> "${GITHUB_OUTPUT}"

          if [ -n "$(git status --porcelain -- "${BLUE_REPOSITORY_PATH}")" ]; then
            echo "changed=true" >> "${GITHUB_OUTPUT}"
          else
            echo "changed=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Commit + tag release
        if: steps.generate.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          git add "${BLUE_REPOSITORY_PATH}"
          git commit -m "release: ${{ steps.generate.outputs.repo_blue_id }}"

          git tag -a "${{ steps.generate.outputs.repo_blue_id }}" -m "Repository release ${{ steps.generate.outputs.repo_blue_id }}"
          git push origin main --follow-tags

      - name: Upload BlueRepository.blue
        if: steps.generate.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.BLUE_REPOSITORY_PATH }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Trigger blue-repository-js
        if: steps.generate.outputs.changed == 'true'
        shell: bash
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.WORKFLOW_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ env.DOWNSTREAM_REPO }}/dispatches \
            -d '{"event_type":"${{ env.DOWNSTREAM_EVENT_TYPE }}","client_payload":{"run_id":"${{ github.run_id }}","workflow":"${{ env.SOURCE_WORKFLOW_FILE }}","repo_blue_id":"${{ steps.generate.outputs.repo_blue_id }}"}}'
