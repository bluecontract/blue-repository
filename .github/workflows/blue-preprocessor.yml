name: Blue Preprocessor Workflow

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  Preprocess:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout LFS objects
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history needed to check changes
          lfs: true

      - name: Fetch LFS files
        run: git lfs fetch --all && git lfs checkout

      - name: Get changed package folders
        run: |
          # Get the base and head commits of the PR
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          
          # Extract unique root folders, excluding .github and files in root
          echo "$CHANGED_FILES" | while read -r FILE; do
            if [[ "$FILE" =~ ^\.github/ ]] || [[ ! "$FILE" =~ "/" ]]; then
              continue
            fi
            
            # Get the root folder
            ROOT_FOLDER=$(echo "$FILE" | cut -d'/' -f1)
            echo "$ROOT_FOLDER"
          done | sort -u > changed_packages.txt
          
          # Print the results
          echo "Changed package folders:"
          cat changed_packages.txt
          
          # Set output for next steps
          if [ -s changed_packages.txt ]; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          fi

      # Updated to Java 17
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'  # Changed from 11 to 17
      
      - name: Set execute permissions for JAR
        run: chmod +x .github/scripts/blue-preprocessor.jar
      
      - name: Run Blue Preprocessor
        run: |
          java -jar ./.github/scripts/blue-preprocessor.jar ./ ./blue-preprocessed
    
      - name: Copy changed_packages.txt to artifacts
        if: env.CHANGES_DETECTED == 'true'
        run: |
          cp changed_packages.txt ./blue-preprocessed/
      
      - name: Upload preprocessed files
        uses: actions/upload-artifact@v4
        with:
          name: blue-preprocessed
          path: ./blue-preprocessed
          retention-days: 5

  TriggerSDKs:
    needs: Preprocess
    runs-on: ubuntu-latest
    steps:
      - name: Trigger blue-repository-js
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.WORKFLOW_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/bluecontract/blue-repository-js/dispatches \
            -d '{"event_type":"blue-preprocessor-completed","client_payload":{"run_id":"${{ github.run_id }}"}}'
