name: Repository Generator (manual)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run against'
        required: true
        type: string
        default: main
      mode:
        description: 'Generator mode (check or write)'
        required: true
        type: choice
        options:
          - check
          - write
        default: write
      allow_diff:
        description: 'In check mode, allow BlueRepository.blue to differ (exit 0)'
        required: true
        type: boolean
        default: true

concurrency:
  group: repository-generator-manual-${{ inputs.branch }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  REPOSITORY_GENERATOR_PACKAGE: '@blue-labs/repository-generator'
  REPOSITORY_GENERATOR_VERSION: '2.0.0-rc.9'
  BLUE_REPOSITORY_PATH: 'BlueRepository.blue'
  ARTIFACT_NAME: 'blue-repository-definition'
  ARTIFACT_RETENTION_DAYS: '10'
  DOWNSTREAM_REPO: 'bluecontract/blue-repository-js'
  DOWNSTREAM_EVENT_TYPE: 'blue-preprocessor-completed'
  SOURCE_WORKFLOW_FILE: 'blue-preprocessor-manual.yml'

jobs:
  Generate:
    name: Generate BlueRepository.blue
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch }}
          token: ${{ secrets.WORKFLOW_PAT || github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run repository-generator
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          MODE='${{ inputs.mode }}'
          ALLOW_DIFF='${{ inputs.allow_diff }}'

          EXTRA_ARGS=()
          if [ "${MODE}" = 'check' ] && [ "${ALLOW_DIFF}" = 'true' ]; then
            EXTRA_ARGS+=(--allow-diff)
          fi

          npm_config_loglevel=error \
            npm exec --yes --package "${REPOSITORY_GENERATOR_PACKAGE}@${REPOSITORY_GENERATOR_VERSION}" -- \
            blue-repo-generator --repo-root . --blue-repository "${BLUE_REPOSITORY_PATH}" --mode "${MODE}" "${EXTRA_ARGS[@]}" \
            | tee /tmp/repository-generator-output.txt

          if [ "${MODE}" = 'write' ]; then
            repoBlueId="$(tail -n 1 /tmp/repository-generator-output.txt | tr -d '\r')"
            if [ -z "${repoBlueId}" ]; then
              echo "Failed to read RepoBlueId from generator output."
              exit 1
            fi

            echo "repo_blue_id=${repoBlueId}" >> "${GITHUB_OUTPUT}"

            if [ -n "$(git status --porcelain -- "${BLUE_REPOSITORY_PATH}")" ]; then
              echo "changed=true" >> "${GITHUB_OUTPUT}"
            else
              echo "changed=false" >> "${GITHUB_OUTPUT}"
            fi
          fi

      - name: Upload BlueRepository.blue
        if: inputs.mode == 'write'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.BLUE_REPOSITORY_PATH }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Trigger blue-repository-js
        if: inputs.mode == 'write' && steps.generate.outputs.changed == 'true'
        shell: bash
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.WORKFLOW_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ env.DOWNSTREAM_REPO }}/dispatches \
            -d '{"event_type":"${{ env.DOWNSTREAM_EVENT_TYPE }}","client_payload":{"run_id":"${{ github.run_id }}","workflow":"${{ env.SOURCE_WORKFLOW_FILE }}","repo_blue_id":"${{ steps.generate.outputs.repo_blue_id }}"}}'
