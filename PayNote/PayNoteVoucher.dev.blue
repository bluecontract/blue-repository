name: PayNote Voucher
description: Voucher contract that funds cashback for eligible card transactions.

voucher:
  description: Voucher configuration supplied at issuance.
  issuerMerchantId:
    type: Text
    description: External merchant identifier funding the voucher (payer).
  targetMerchantId:
    type: Text
    description: External merchant identifier whose purchases are eligible.
  limitMinor:
    type: Integer
    description: Maximum cashback amount in minor currency units.

activatedAt:
  type: Integer # TODO: replace with Timestamp when we can use Date class to format ISO Timestamp in JS expressions
  description: Timestamp (microseconds since epoch) when the voucher was activated.

status:
  type: Conversation/Document Status
  description: Current voucher status.
  value:
    type: Conversation/Status Pending

terminatedAt:
  type: Integer # TODO: replace with Timestamp when we can use Date class to format ISO Timestamp in JS expressions
  description: Timestamp (microseconds since epoch) when the voucher was terminated.

monitoringStatus:
  type: Text
  description: Monitoring lifecycle status (requested, started, rejected).

monitoringStartedAt:
  type: Integer # TODO: replace with Timestamp when we can use Date class to format ISO Timestamp in JS expressions
  description: Timestamp (microseconds since epoch) when monitoring started.

monitoringRejectedAt:
  type: Integer # TODO: replace with Timestamp when we can use Date class to format ISO Timestamp in JS expressions
  description: Timestamp (microseconds since epoch) when monitoring was rejected.

monitoringRejectionReason:
  type: Text
  description: Reason monitoring was rejected.

reportedTransactionsById:
  type: Dictionary
  keyType: Text
  valueType: PayNote/Card Transaction Report
  description: Map of reported transactions keyed by transactionId for idempotency.

voucherCashbackCaptureByTransactionId:
  type: Dictionary
  keyType: Text
  valueType:
    name: Capture Record
    description: Voucher cashback capture lifecycle record for an eligible transaction.
    status:
      type: Text
      description: Voucher cashback capture status (requested, captured, declined, failed).
    requestedAmountMinor:
      type: Integer
      description: Cashback amount requested for capture, in minor units.
    capturedAmountMinor:
      type: Integer
      description: Cashback amount confirmed as captured, in minor units.
    failureReason:
      type: Text
      description: Reason for declined or failed cashback capture, if applicable.
  description: Voucher cashback capture record per transaction.

paidOutAmountMinor:
  type: Integer
  description: Total cashback amount confirmed as paid out.
  value: 0

remainingAmountMinor:
  type: Integer
  description: Remaining cashback amount available for future payouts.
  value: 0

contracts:
  payerChannel:
    type: MyOS/MyOS Timeline Channel
    description: Voucher issuer (merchant/payer).
  payeeChannel:
    type: MyOS/MyOS Timeline Channel
    description: Voucher recipient (client/payee).
  guarantorChannel:
    type: MyOS/MyOS Timeline Channel
    description: Bank/guarantor responsible for monitoring and payouts.
  eventsChannel:
    type: Core/Triggered Event Channel
  initLifecycleChannel:
    type: Core/Lifecycle Event Channel
    event:
      type: Core/Document Processing Initiated

  activateVoucher:
    type: Conversation/Operation
    description: Client grants consent for the bank to monitor card transactions at the target merchant and report them into this document, then activates the voucher.
    channel: payeeChannel
  rejectVoucher:
    type: Conversation/Operation
    description: Client rejects the voucher and declines consent for monitoring.
    channel: payeeChannel
    request:
      reason:
        type: Text
        description: Optional reason for rejecting the voucher.

  activateVoucherImpl:
    type: Conversation/Sequential Workflow Operation
    operation: activateVoucher
    steps:
      - name: Prepare Activation
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;
          const currentActivatedAt = document('/activatedAt');
          const alreadyActivated = currentActivatedAt > 0;
          const targetMerchantId = document('/voucher/targetMerchantId') || '';
          const limitMinor = document('/voucher/limitMinor');
          const events = [];
          const changeset = [];

          if (!alreadyActivated) {
            changeset.push({ op: 'replace', path: '/activatedAt', val: timestamp });
            changeset.push({
              op: 'replace',
              path: '/status',
              val: { type: 'Conversation/Status In Progress' }
            });

            if (Number.isFinite(limitMinor) && limitMinor >= 0) {
              changeset.push({ op: 'replace', path: '/paidOutAmountMinor', val: 0 });
              changeset.push({ op: 'replace', path: '/remainingAmountMinor', val: limitMinor });
              events.push({
                type: 'PayNote/Reserve Funds Requested',
                amount: limitMinor
              });
            }

            if (targetMerchantId.trim().length > 0) {
              events.push({
                type: 'PayNote/Card Transaction Monitoring Consent Granted',
                targetMerchantId,
                grantedAt: timestamp
              });
            }
          }

          return {
            changeset,
            events
          };

      - name: Apply Activation
        type: Conversation/Update Document
        changeset: "${steps['Prepare Activation'].changeset}"

  rejectVoucherImpl:
    type: Conversation/Sequential Workflow Operation
    operation: rejectVoucher
    steps:
      - name: Prepare Rejection
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          const targetMerchantId = document('/voucher/targetMerchantId') || '';
          const activatedAt = document('/activatedAt');
          const limitMinor = document('/voucher/limitMinor');
          const changeset = [
            { op: 'replace', path: '/monitoringStatus', val: 'rejected' },
            { op: 'replace', path: '/monitoringRejectedAt', val: timestamp },
            { op: 'replace', path: '/monitoringRejectionReason', val: reason }
          ];

          const events = [
            {
              type: 'PayNote/Card Transaction Monitoring Consent Rejected',
              targetMerchantId,
              reason,
              rejectedAt: timestamp
            }
          ];

          if (activatedAt > 0 && Number.isFinite(limitMinor) && limitMinor >= 0) {
            events.push({
              type: 'PayNote/Reservation Release Requested',
              amount: limitMinor
            });
          } else if (!(activatedAt > 0)) {
            changeset.push({
              op: 'replace',
              path: '/status',
              val: { type: 'Conversation/Status Completed' }
            });
            changeset.push({ op: 'replace', path: '/terminatedAt', val: timestamp });
          }

          return { changeset, events };

      - name: Apply Rejection
        type: Conversation/Update Document
        changeset: "${steps['Prepare Rejection'].changeset}"

  requestMonitoringConsentOnInit:
    type: Conversation/Sequential Workflow
    channel: initLifecycleChannel
    steps:
      - name: Emit Consent Requested
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;
          const targetMerchantId = document('/voucher/targetMerchantId') || '';
          if (!targetMerchantId.trim()) {
            return { events: [] };
          }

          return {
            events: [
              {
                type: 'PayNote/Card Transaction Monitoring Consent Requested',
                targetMerchantId,
                requestedAt: timestamp
              }
            ]
          };

  confirmCardTransactionMonitoringStarted:
    type: Conversation/Operation
    description: Bank confirms that monitoring has started.
    channel: guarantorChannel

  confirmCardTransactionMonitoringStartedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: confirmCardTransactionMonitoringStarted
    steps:
      - name: Prepare Confirmation
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;
          const currentStatus = document('/monitoringStatus');
          const targetMerchantId = document('/voucher/targetMerchantId');
          const events = [];
          const changeset = [];

          if (currentStatus === 'requested') {
            changeset.push({ op: 'replace', path: '/monitoringStatus', val: 'started' });
            changeset.push({ op: 'replace', path: '/monitoringStartedAt', val: timestamp });
            events.push({
              type: 'PayNote/Card Transaction Monitoring Started',
              targetMerchantId,
              startedAt: timestamp
            });
          }

          return {
            changeset,
            events
          };

      - name: Apply Confirmation
        type: Conversation/Update Document
        changeset: "${steps['Prepare Confirmation'].changeset}"

  rejectCardTransactionMonitoringRequest:
    type: Conversation/Operation
    description: Bank rejects the monitoring request.
    channel: guarantorChannel
    request:
      reason:
        type: Text
        description: Reason for rejecting monitoring.

  confirmFundsReserved:
    type: Conversation/Operation
    description: Bank confirms that funds were reserved for the voucher.
    channel: guarantorChannel
    request:
      amountReserved:
        type: Integer
        description: Amount reserved in minor currency units.

  reportReservationDeclined:
    type: Conversation/Operation
    description: Bank reports that the voucher reservation request was declined.
    channel: guarantorChannel
    request:
      reason:
        type: Text
        description: Reason reservation was declined.

  confirmReservationReleased:
    type: Conversation/Operation
    description: Bank confirms that reserved funds were released.
    channel: guarantorChannel
    request:
      amountReleased:
        type: Integer
        description: Amount released in minor currency units.

  reportReservationReleaseDeclined:
    type: Conversation/Operation
    description: Bank reports that the reservation release request was declined.
    channel: guarantorChannel
    request:
      reason:
        type: Text
        description: Reason release was declined.

  confirmFundsCaptured:
    type: Conversation/Operation
    description: Bank confirms that cashback funds were captured.
    channel: guarantorChannel
    request:
      amountCaptured:
        type: Integer
        description: Amount captured in minor currency units.

  reportCaptureDeclined:
    type: Conversation/Operation
    description: Bank reports that the cashback capture request was declined.
    channel: guarantorChannel
    request:
      reason:
        type: Text
        description: Reason capture was declined.

  reportCaptureFailure:
    type: Conversation/Operation
    description: Bank reports cashback capture failed for a technical reason.
    channel: guarantorChannel
    request:
      reason:
        type: Text
        description: Reason capture failed.

  rejectCardTransactionMonitoringRequestImpl:
    type: Conversation/Sequential Workflow Operation
    operation: rejectCardTransactionMonitoringRequest
    steps:
      - name: Prepare Rejection
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;
          const currentStatus = document('/monitoringStatus');
          const alreadyStarted = currentStatus === 'started';
          const alreadyRejected = currentStatus === 'rejected';
          const targetMerchantId = document('/voucher/targetMerchantId');
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          const events = [];
          const changeset = [];

          if (!alreadyStarted && !alreadyRejected) {
            changeset.push({ op: 'replace', path: '/monitoringStatus', val: 'rejected' });
            changeset.push({ op: 'replace', path: '/monitoringRejectedAt', val: timestamp });
            changeset.push({ op: 'replace', path: '/monitoringRejectionReason', val: reason });
            changeset.push({
              op: 'replace',
              path: '/status',
              val: { type: 'Conversation/Status Failed' }
            });
            changeset.push({ op: 'replace', path: '/terminatedAt', val: timestamp });
            events.push({
              type: 'PayNote/Card Transaction Monitoring Request Rejected',
              targetMerchantId,
              reason,
              rejectedAt: timestamp
            });

            const limitMinor = document('/voucher/limitMinor');
            if (Number.isFinite(limitMinor) && limitMinor >= 0) {
              events.push({
                type: 'PayNote/Reservation Release Requested',
                amount: limitMinor
              });
            }
          }

          return {
            changeset,
            events
          };

      - name: Apply Rejection
        type: Conversation/Update Document
        changeset: "${steps['Prepare Rejection'].changeset}"

  confirmFundsReservedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: confirmFundsReserved
    steps:
      - name: Emit Funds Reserved
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const amountReserved = request.amountReserved;
          return {
            events: [
              {
                type: 'PayNote/Funds Reserved',
                amountReserved
              }
            ]
          };

  reportReservationDeclinedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: reportReservationDeclined
    steps:
      - name: Emit Reservation Declined
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          return {
            events: [
              {
                type: 'PayNote/Reservation Declined',
                reason
              }
            ]
          };

  confirmReservationReleasedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: confirmReservationReleased
    steps:
      - name: Emit Reservation Released
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const amountReleased = request.amountReleased;
          return {
            events: [
              {
                type: 'PayNote/Reservation Released',
                amountReleased
              }
            ]
          };

  reportReservationReleaseDeclinedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: reportReservationReleaseDeclined
    steps:
      - name: Emit Reservation Release Declined
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          return {
            events: [
              {
                type: 'PayNote/Reservation Release Declined',
                reason
              }
            ]
          };

  confirmFundsCapturedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: confirmFundsCaptured
    steps:
      - name: Emit Funds Captured
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const amountCaptured = request.amountCaptured;
          return {
            events: [
              {
                type: 'PayNote/Funds Captured',
                amountCaptured
              }
            ]
          };

  reportCaptureDeclinedImpl:
    type: Conversation/Sequential Workflow Operation
    operation: reportCaptureDeclined
    steps:
      - name: Emit Capture Declined
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          return {
            events: [
              {
                type: 'PayNote/Capture Declined',
                reason
              }
            ]
          };

  reportCaptureFailureImpl:
    type: Conversation/Sequential Workflow Operation
    operation: reportCaptureFailure
    steps:
      - name: Emit Capture Failed
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const reason = request.reason || '';
          return {
            events: [
              {
                type: 'PayNote/Capture Failed',
                reason
              }
            ]
          };

  handleFundsReserved:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Funds Reserved
    steps:
      - name: Prepare Monitoring Request
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;

          const activatedAt = document('/activatedAt');
          if (!(activatedAt > 0)) {
            return { changeset: [], events: [] };
          }

          const monitoringStatus = document('/monitoringStatus');
          if (monitoringStatus === 'requested' || monitoringStatus === 'started' || monitoringStatus === 'rejected') {
            return { changeset: [], events: [] };
          }

          const targetMerchantId = document('/voucher/targetMerchantId') || '';
          if (!targetMerchantId.trim()) {
            return { changeset: [], events: [] };
          }

          return {
            changeset: [{ op: 'replace', path: '/monitoringStatus', val: 'requested' }],
            events: [
              {
                type: 'PayNote/Start Card Transaction Monitoring Requested',
                targetMerchantId,
                reportOperationName: 'reportCardTransaction',
                requestedAt: timestamp
              }
            ]
          };

      - name: Apply Monitoring Request
        type: Conversation/Update Document
        changeset: "${steps['Prepare Monitoring Request'].changeset}"

  handleReservationDeclined:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Reservation Declined
    steps:
      - name: Prepare Termination
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;

          return {
            changeset: [
              { op: 'replace', path: '/status', val: { type: 'Conversation/Status Failed' } },
              { op: 'replace', path: '/terminatedAt', val: timestamp }
            ]
          };

      - name: Apply Termination
        type: Conversation/Update Document
        changeset: "${steps['Prepare Termination'].changeset}"

  handleReservationReleased:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Reservation Released
    steps:
      - name: Prepare Termination
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;

          return {
            changeset: [
              { op: 'replace', path: '/status', val: { type: 'Conversation/Status Completed' } },
              { op: 'replace', path: '/terminatedAt', val: timestamp }
            ]
          };

      - name: Apply Termination
        type: Conversation/Update Document
        changeset: "${steps['Prepare Termination'].changeset}"

  handleReservationReleaseDeclined:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Reservation Release Declined
    steps:
      - name: Prepare Termination
        type: Conversation/JavaScript Code
        code: |
          const timestamp = event?.timestamp;

          return {
            changeset: [
              { op: 'replace', path: '/status', val: { type: 'Conversation/Status Failed' } },
              { op: 'replace', path: '/terminatedAt', val: timestamp }
            ]
          };

      - name: Apply Termination
        type: Conversation/Update Document
        changeset: "${steps['Prepare Termination'].changeset}"

  handleEligibleCardTransactionReported:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Eligible Card Transaction Reported
    steps:
      - name: Prepare Capture Request
        type: Conversation/JavaScript Code
        code: |
          const report = event?.report || {};
          const transactionId = report.transactionId || '';
          const eligibleCashbackMinor = event?.eligibleCashbackMinor;
          const captureByTransactionId = document('/voucherCashbackCaptureByTransactionId') || {};
          const remainingAmountMinor = document('/remainingAmountMinor');
          const limitMinor = document('/voucher/limitMinor');

          if (!transactionId) {
            return { changeset: [], events: [] };
          }
          if (captureByTransactionId[transactionId]) {
            return { changeset: [], events: [] };
          }
          if (!Number.isFinite(eligibleCashbackMinor) || eligibleCashbackMinor <= 0) {
            return { changeset: [], events: [] };
          }

          const availableRemaining = Number.isFinite(remainingAmountMinor)
            ? remainingAmountMinor
            : Number.isFinite(limitMinor)
              ? limitMinor
              : 0;
          const captureAmount = Math.min(eligibleCashbackMinor, availableRemaining);
          if (!Number.isFinite(captureAmount) || captureAmount <= 0) {
            return { changeset: [], events: [] };
          }

          return {
            changeset: [
              {
                op: 'replace',
                path: `/voucherCashbackCaptureByTransactionId/${transactionId}`,
                val: {
                  status: 'requested',
                  requestedAmountMinor: captureAmount,
                  capturedAmountMinor: 0,
                  failureReason: ''
                }
              }
            ],
            events: [
              {
                type: 'PayNote/Capture Funds Requested',
                requestId: `voucher-capture:${transactionId}`,
                amount: captureAmount
              }
            ]
          };

      - name: Apply Capture Request
        type: Conversation/Update Document
        changeset: "${steps['Prepare Capture Request'].changeset}"

  handleFundsCaptured:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Funds Captured
    steps:
      - name: Prepare Capture Confirmation
        type: Conversation/JavaScript Code
        code: |
          const amountCaptured = event?.amountCaptured;
          if (!Number.isFinite(amountCaptured) || amountCaptured <= 0) {
            return { changeset: [] };
          }

          const paidOutAmountMinor = document('/paidOutAmountMinor');
          const remainingAmountMinor = document('/remainingAmountMinor');
          const limitMinor = document('/voucher/limitMinor');
          const nextPaidOutAmountMinor =
            (Number.isFinite(paidOutAmountMinor) ? paidOutAmountMinor : 0) +
            amountCaptured;
          let nextRemainingAmountMinor;
          if (Number.isFinite(remainingAmountMinor)) {
            nextRemainingAmountMinor = Math.max(0, remainingAmountMinor - amountCaptured);
          } else if (Number.isFinite(limitMinor)) {
            nextRemainingAmountMinor = Math.max(0, limitMinor - nextPaidOutAmountMinor);
          }

          const changeset = [
            { op: 'replace', path: '/paidOutAmountMinor', val: nextPaidOutAmountMinor }
          ];
          if (Number.isFinite(nextRemainingAmountMinor)) {
            changeset.push({
              op: 'replace',
              path: '/remainingAmountMinor',
              val: nextRemainingAmountMinor
            });
          }

          const responseRequestId = event?.inResponseTo?.requestId || '';
          const requestPrefix = 'voucher-capture:';
          const transactionId = responseRequestId.startsWith(requestPrefix)
            ? responseRequestId.slice(requestPrefix.length)
            : '';
          if (transactionId) {
            const existingRecord =
              document(`/voucherCashbackCaptureByTransactionId/${transactionId}`) || {};
            changeset.push({
              op: 'replace',
              path: `/voucherCashbackCaptureByTransactionId/${transactionId}`,
              val: {
                status: 'captured',
                requestedAmountMinor: existingRecord.requestedAmountMinor,
                capturedAmountMinor: amountCaptured,
                failureReason: ''
              }
            });
          }

          return { changeset };

      - name: Apply Capture Confirmation
        type: Conversation/Update Document
        changeset: "${steps['Prepare Capture Confirmation'].changeset}"

  handleCaptureDeclined:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Capture Declined
    steps:
      - name: Prepare Capture Decline
        type: Conversation/JavaScript Code
        code: |
          const reason = event?.reason || '';
          const responseRequestId = event?.inResponseTo?.requestId || '';
          const requestPrefix = 'voucher-capture:';
          const transactionId = responseRequestId.startsWith(requestPrefix)
            ? responseRequestId.slice(requestPrefix.length)
            : '';
          if (!transactionId) {
            return { changeset: [] };
          }

          const existingRecord =
            document(`/voucherCashbackCaptureByTransactionId/${transactionId}`) || {};
          const changeset = [
            {
              op: 'replace',
              path: `/voucherCashbackCaptureByTransactionId/${transactionId}`,
              val: {
                status: 'declined',
                requestedAmountMinor: existingRecord.requestedAmountMinor,
                capturedAmountMinor: existingRecord.capturedAmountMinor,
                failureReason: reason
              }
            }
          ];

          return { changeset };

      - name: Apply Capture Decline
        type: Conversation/Update Document
        changeset: "${steps['Prepare Capture Decline'].changeset}"

  handleCaptureFailed:
    type: Conversation/Sequential Workflow
    channel: eventsChannel
    event:
      type: PayNote/Capture Failed
    steps:
      - name: Prepare Capture Failure
        type: Conversation/JavaScript Code
        code: |
          const reason = event?.reason || '';
          const responseRequestId = event?.inResponseTo?.requestId || '';
          const requestPrefix = 'voucher-capture:';
          const transactionId = responseRequestId.startsWith(requestPrefix)
            ? responseRequestId.slice(requestPrefix.length)
            : '';
          if (!transactionId) {
            return { changeset: [] };
          }

          const existingRecord =
            document(`/voucherCashbackCaptureByTransactionId/${transactionId}`) || {};
          const changeset = [
            {
              op: 'replace',
              path: `/voucherCashbackCaptureByTransactionId/${transactionId}`,
              val: {
                status: 'failed',
                requestedAmountMinor: existingRecord.requestedAmountMinor,
                capturedAmountMinor: existingRecord.capturedAmountMinor,
                failureReason: reason
              }
            }
          ];

          return { changeset };

      - name: Apply Capture Failure
        type: Conversation/Update Document
        changeset: "${steps['Prepare Capture Failure'].changeset}"

  reportCardTransaction:
    type: Conversation/Operation
    description: Bank reports a captured card transaction into the voucher.
    channel: guarantorChannel
    request:
      type: PayNote/Card Transaction Report

  reportCardTransactionImpl:
    type: Conversation/Sequential Workflow Operation
    operation: reportCardTransaction
    steps:
      - name: Prepare Report
        type: Conversation/JavaScript Code
        code: |
          const request = event?.message?.request || {};
          const transactionId = request.transactionId?.trim() || '';
          const events = [];
          const changeset = [];

          const amountMinor = request.amountMinor;
          const currency = request.currency || '';
          const merchantId = request.merchantId || '';
          const occurredAt = request.occurredAt || '';
          const report = {
            transactionId,
            merchantId,
            amountMinor,
            currency,
            occurredAt
          };

          if (!transactionId) {
            events.push({
              type: 'PayNote/Ineligible Card Transaction Reported',
              report,
              reason: 'Transaction id is missing.'
            });
            return { changeset, events };
          }

          const existing = document(`/reportedTransactionsById/${transactionId}`);
          if (existing) {
            events.push({
              type: 'PayNote/Ineligible Card Transaction Reported',
              report,
              reason: 'Duplicate transaction id.'
            });
            return { changeset, events };
          }

          const targetMerchantId = document('/voucher/targetMerchantId');
          const monitoringStatus = document('/monitoringStatus');
          const activatedAt = document('/activatedAt');
          const limitMinor = document('/voucher/limitMinor');
          const remainingAmountMinor = document('/remainingAmountMinor');
          const reasons = [];

          if (!(activatedAt > 0)) {
            reasons.push('Voucher is not activated.');
          }
          if (monitoringStatus !== 'started') {
            reasons.push('Monitoring has not started.');
          }
          if (!merchantId || merchantId !== targetMerchantId) {
            reasons.push('Merchant does not match the voucher target merchant.');
          }
          if (!Number.isFinite(amountMinor) || amountMinor < 0) {
            reasons.push('Amount is invalid.');
          }
          if (!currency) {
            reasons.push('Currency is missing.');
          }
          if (!occurredAt) {
            reasons.push('Occurred-at timestamp is missing.');
          }
          const availableLimit = Number.isFinite(remainingAmountMinor)
            ? remainingAmountMinor
            : limitMinor;
          if (!Number.isFinite(availableLimit) || availableLimit < 0) {
            reasons.push('Voucher limit is invalid.');
          } else if (availableLimit === 0) {
            reasons.push('Voucher has no remaining balance.');
          }

          if (reasons.length === 0) {
            const eligibleCashbackMinor = Math.min(availableLimit, amountMinor);
            changeset.push({
              op: 'replace',
              path: `/reportedTransactionsById/${transactionId}`,
              val: report
            });
            events.push({
              type: 'PayNote/Eligible Card Transaction Reported',
              report,
              eligibleCashbackMinor
            });
          } else {
            events.push({
              type: 'PayNote/Ineligible Card Transaction Reported',
              report,
              reason: reasons.join('; ')
            });
          }

          return {
            changeset,
            events
          };

      - name: Apply Report
        type: Conversation/Update Document
        changeset: "${steps['Prepare Report'].changeset}"
