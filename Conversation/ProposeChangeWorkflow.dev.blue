name: Propose Change Workflow
type: Conversation/Sequential Workflow Operation
description: Stores a proposed change under /proposedChange{postfix}.
request:
  type: Conversation/Change Request
  description: Expected request payload for this workflow.
postfix:
  type: Text
  description: Optional postfix used while building proposed change state key.
steps:
  - name: Prepare
    type: Conversation/JavaScript Code
    code: |
      const invalid = (reason) => ({
        changeset: [],
        events: [{ type: 'Conversation/Proposed Change Invalid', reason }]
      });

      const request = event.message.request;

      const summary = request?.summary;
      if (!summary || typeof summary !== 'string') {
        return invalid('summary is missing');
      }

      const postfixValue = currentContract?.postfix || '';
      const path = '/proposedChange' + postfixValue;

      if (document(path)) {
        return invalid('proposed change already exists at ' + path);
      }

      return {
        changeset: [{ op: 'add', path, val: request }]
      };

  - name: Apply
    type: Conversation/Update Document
    changeset: '${steps.Prepare.changeset}'
