name: Update Document
type: Conversation/Sequential Workflow Step
description: >
  Updates the document with the provided changeset.

  - Gas accounting (when and what is charged):
      - Base step charge (once per run of this step): 40 + 5 * changesetLength.
      - Expression/template resolution under "/changeset/**" (if present):
          - Expressions run in the deterministic QuickJS VM (same sandbox and
            bindings as the JavaScript Code step).
          - VM gas is converted to host gas as:
            hostGas = ceil(wasmFuel / 1700)
            (calibration factor currently 1700 fuel per host gas unit).
          - Any document(<pointer>) used inside expressions/templates charges
            per call: 8 + depth(pointer) + ceil(snapshotBytes/100).
      - Per change (applied in order after boundary validation):
          - Boundary check: 2.
          - Operation charge:
              - add or replace: 20 + ceil(valueBytes/100) (valueBytes is the
                canonical JSON size of val).
              - remove: 10.
          - Cascade routing (Document Update delivery):
            10 * N, where N is the number of scopes that receive the resulting
            Document Update (origin scope and each participating ancestor up to root).

changeset:
  type: List
  itemType: Core/Json Patch Entry
